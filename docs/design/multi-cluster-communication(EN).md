# Multi-cluster communication design

## Summary

Multi-cluster communication aims to enable multiple heterogeneous clusters distributed on different networks to access each other's nodes and services (currently, only cloud nodes of the cluster can communicate with each other).  

There must be only one host cluster in multiple communication clusters, and the other clusters are members of the main cluster. Each member cluster registers with the main cluster the endpoint information that it needs to communicate with the external cluster (currently only the Connector). 

Clusters cannot communicate with each other directly. You need to organize clusters that need to communicate with each other in the primary cluster through the community so that clusters in the same community can access each other.  

The addresses of nodes, PODS, and services must be unique between clusters.

## Cluster classification 

### By system

* Regular Kubernetes cluster 
* edge computing cluster (KubeEdge/OpenYurt/SuperEdge). 

###  Categorize by topology

* All nodes are in one area, and the network is also in a LAN, usually a Kubernetes cluster inside the enterprise or on the cloud, running various services, or perhaps a small cluster of some kind of facility.  
* Management nodes in the cloud, edge nodes in multiple locations, using different networks. 

### By role

There can be multiple communication clusters, but there are two types of roles: primary cluster and member cluster. The primary cluster must have only one .

The functions of the primary cluster are as follows: 

* Certificate distribution. The root certificate of all clusters is stored in the host group. Member clusters can apply for certificates for Connector and Agent from the main cluster.  
*  Centralized storage of endpoint information exposed for each cluster is currently limited to the Connector.
* Community management, where the clusters that need to communicate must be in the same community.
*  Deliver endpoint information about the cluster that you want to communicate to other clusters.

The member cluster has the following functions: 
* Apply to the primary cluster for the endpoint certificate of this cluster .
* Provide the main cluster with its own externally exposed endpoint information.
* Obtain endpoint information of other clusters through the main cluster, and establish communication with other clusters.

## Custom resources 

To manage communication between multiple clusters, some CRDS need to be added or modified. 

#### Community

Community, previously used to manage communication between edge nodes within a cluster, can now be used to manage multiple clusters that need to communicate, but inter-cluster communication between edge nodes is not currently supported. Currently, members within a community must be of the same type, either edge nodes of the cluster or connectors of each cluster. 

#### Cluster

Cluster is a data structure used by the primary Cluster to record information about other Cluster endpoints. It has the following fields: 

 * name.  Cluster name. Each member cluster declares its own identity when accessing the master cluster. 

 * Token.  Used for member cluster initialization, the token is generated by the operator of the primary cluster.  

 * Endpoints.  All endpoints within the cluster that need to communicate with other clusters, of which Connector must be uploaded.  

   	* Name.  The Name must be unique. You are advised to configure the cluster domain to be unique. 
   *  PublicAddresses.  Public address of the cluster for external communication. This address must be accessible to other clusters and edge nodes of the cluster (if any)  
   *  Subnets.  Primarily PodCIDRs data for the cluster, but also contains ServiceCIDR that provides the cluster.  
   *  NodeCIDRs.  IP addresses of all nodes in the cloud nodes within the cluster.
   * Type.  Indicates the endpoint types: Connector and EdgeNode.

   

## Name management

In order to achieve this goal, when each cluster reports the endpoint information of the cluster, it is necessary to modify the name and add the cluster prefix. For example, the Connector name of Cluster1 should be changed to: Cluster1. Connector.  

