# Operator

## Summary

Operator has several functions :

  * Allocate network segments for edge nodes.
  * Deploy fabedge-agent for edge nodes.
  * Generate tunnel configurations and service broker rule configurations for edge nodes, which are consumed by fabedge-agent.
  *  Generate tunnel configuration for fabedge-connector.
  * Community management.

The above functions are implemented by several components of Operator :
  * agent controller 
  * community controller
  * connector controller
  * proxy controller

## Agent Controller

Agent controller is responsible for the following functions:  

  * Edge node network segment allocation.
  * fabedge-agent deployment.
  * Edge node tunnel configuration management.

### Edge node segment allocation  

The Agent Controller monitors the edge nodes of the Kubernetes cluster. If a node does not have a network segment, the Agent controller selects a network segment from the configured IP address pool and assigns it to the node.  

The network segment information is recorded in annotations of the node, corresponding to the key value`fabedge.io/subnets`.  

If the Agent Controller finds that the network segment allocated to an edge node is faulty, it will also re-allocate a network segment.  

### fabedge-agent deployment

When the Agent controller finds a new edge node, it creates a `fabedge-agent pod` for the edge node. The `pod` is deployed on the new edge node and runs in host network mode.  

### Edge node tunnel configuration management  

The Agent Controller monitors the changes of edge nodes. If the IP address, network segment allocation, or community relationship of edge nodes changes, the Agent regenerates tunnel configurations to the dedicated `configmap` of this node for Agent processing.  

## Community Controller

In order to realize the communication between edge nodes, but not because of too much tunnel configuration to the edge node unnecessary burden. Fabedge came up with a concept called Community. When some edge nodes need to access each other,  

You can add them to the same community, then register these community relationships with the `community controller`, and finally generate the corresponding tunnel configuration by the `agent-controller`.  

## Connector Controller

Connector is the cloud component responsible for implementing cloud-side communication, and its tunnel configuration is generated by the `connector controller`.  

## Proxy Controller

The function of Proxy Controller is similar to `kube-proxy`. It listens to all `Services` and `EndpointSlice`. When a `Service` has an Endpoint on the edge node, it generates a Proxy rule for the node.  

This rule is consumed by the `Agent` and corresponding IPVS rule is generated. In this way, when the Pod of this node accesses the Service, it only accesses the endpoint of the local node, not the endpoint of the cloud.  
