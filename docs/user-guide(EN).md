# FabEdge User manual

[toc]

## Use the community  

By default, the pod on the edge node can only access the cloud pod and the node, and the pod on the edge node cannot communicate with each other, in order to avoid unnecessary waste caused by the establishment of too many tunnels on the edge node. In order to make the edge nodes that need to communicate accessible to each other, we put forward the concept of community. When several edge nodes need to communicate with each other, a community can be established, and the nodes that need to communicate can be put into the list of community members, so that these community members can access each other.  

After multi-cluster communication is implemented, communities can also be used to organize clusters that need to communicate with each other.  

Creating a community is very simple. Suppose we now have an edge cluster, which we call "beijing" when deployed, and there are three edge nodes edge1, edge2, and edge3 in the cluster.  

Create the following communities:  

```yaml
apiVersion: fabedge.io/v1alpha1
kind: Community
metadata:
  name: all-edge-nodes
spec:
  members:
    - beijing.edge1
    - beijing.edge2
    - beijing.edge3
```

> Note: Community member names are not node names, but endpoint names, the endpoint name of a node "cluster name. node name ". 

Suppose we have another edge cluster, named "shanghai" when deployed, we now need to communicate between **beijing** and **shanghai** to create the following cluster:  

```yaml
apiVersion: fabedge.io/v1alpha1
kind: Community
metadata:
  name: connectors
spec:
  members:
    - beijing.connector
    - shanghai.connector
```

> Note: Cross-cluster communication is primarily implemented by connectors, so the member name is the endpoint name of the connector for each cluster.

## Register the cluster

Multi-cluster communication requires the registration of endpoint information of each cluster in the host group:

1. Create a cluster resource in the primary cluster: 

   ```yaml
   apiVersion: fabedge.io/v1alpha1
   kind: Cluster
   metadata:
     name: beijing
   ```

2. Check the token

   ```shell
   # kubectl describe cluster beijing
   Name:         beijing
   Namespace:    
   Kind:         Cluster
   Spec:
     Token:   eyJhbGciOi--omitted--4PebW68A
   
   ```

   > Note: The token is generated by the fabedge-operator. Within the validity period, the token is used to initialize the member cluster.

3. Deploy the FabEdge in a member cluster using the token generated in the first step. The operator of the member cluster reports the connector information of the cluster to the host group.

   ```yaml
   # kubectl get cluster beijing -o yaml
   apiVersion: fabedge.io/v1alpha1
   kind: Cluster
     name: beijing
   spec:
     endPoints:
     - id: C=CN, O=fabedge.io, CN=beijing.connector
       name: beijing.connector
       nodeSubnets:
       - 10.20.8.12
       - 10.20.8.38
       publicAddresses:
       - 10.20.8.12
       subnets:
       - 10.233.0.0/18
       - 10.233.70.0/24
       - 10.233.90.0/24
       type: Connector
     token: eyJhbGciOi--omit--4PebW68A
   ```



## Verify the certificate 

FabEdge related certificates, including CA, Connector, and Agent, are stored in Secret and maintained by Operator automatically. If a certificate-related error occurs, you can use the following method to manually verify.  

```shell
# Execute on the master node.

# Start a container for cert.
docker run fabedge/cert

# Get the ID of the container you just started.  
docker ps -a | grep cert
65ceb57d6656   fabedge/cert                  "/usr/local/bin/fabeâ€¦"   15 seconds ago   

# Copy the executable to the host.
docker cp 65ceb57d6656:/usr/local/bin/fabedge-cert .

# Check out Secret.  
kubectl get secret -n fabedge
NAME                            TYPE                                  DATA   AGE
api-server-tls                  kubernetes.io/tls                     4      3d22h
cert-token-csffn                kubernetes.io/service-account-token   3      3d22h
connector-tls                   kubernetes.io/tls                     4      3d22h
default-token-rq9mv             kubernetes.io/service-account-token   3      3d22h
fabedge-agent-tls-edge1         kubernetes.io/tls                     4      3d22h
fabedge-agent-tls-edge2         kubernetes.io/tls                     4      3d22h
fabedge-ca                      Opaque                                2      3d22h
fabedge-operator-token-tb8qb    kubernetes.io/service-account-token   3      3d22h

# Verify related Secret.  
./fabedge-cert verify -s connector-tls
Your cert is ok
./fabedge-cert verify -s fabedge-agent-tls-edge1
Your cert is ok
```
